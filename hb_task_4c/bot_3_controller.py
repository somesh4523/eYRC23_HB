#! /usr/bin/env python3

'''
*******************************
*
*        		===============================================
*           		Hologlyph Bots (HB) Theme (eYRC 2023-24)
*        		===============================================
*
*  This script is to implement Task 2B of Hologlyph Bots (HB) Theme (eYRC 2023-24).
*  
*  This software is made available on an "AS IS WHERE IS BASIS".
*  Licensee/end user indemnifies and will keep e-Yantra indemnified from
*  any and all claim(s) that emanate from the use of the Software or 
*  breach of the terms of this agreement.
*
*******************************
'''


# Team ID:		1039
# Author List:		Nidhi Choudhary
# Filename:		bot_1_controller.py
# Functions:
# [ Comma separated list of functions in this file ]
# Nodes:		Add your publishing and subscribing node


################### IMPORT MODULES #######################

import rclpy
from rclpy.node import Node
import time
import math
import numpy as np
from tf_transformations import euler_from_quaternion
from my_robot_interfaces.msg import Goal
from std_msgs.msg import Bool

from geometry_msgs.msg import Wrench
from geometry_msgs.msg import Pose2D


class HBController(Node):
    def __init__(self):
        super().__init__('hb_controller')

        self.theta_pen = np.deg2rad(6.61)

        #waypoints for it to travel

        self.bot_1_x = [292.7880470074263, 287.4740102210353, 282.26406480412874, 277.17783137515795, 272.23408145340613, 267.45066505106786, 262.8444424259442, 258.4312202616252, 254.225692523787, 250.24138622196756, 246.49061228605103, 242.98442174572338, 239.7325673794509, 236.7434709771879, 234.02419633810453, 231.58042810123874, 229.41645648322464, 227.53516797321163, 225.93804201086377, 224.62515364902515, 223.59518217833931, 222.84542566691644, 222.3718213441614, 222.1689717341845, 222.23017642092805, 222.5474693043358, 223.11166118466662, 223.91238749049543, 224.9381609451385, 226.17642894627144, 227.6136354144561, 229.23528684822904, 231.0260223064113, 232.96968702243203, 235.049409340788, 237.24768065235003, 239.54643799311233, 241.92714896023486, 244.37089858986985, 246.85847783334563, 249.37047326183364, 251.8873576246624, 254.38958088299773, 256.8576613386938, 259.2722764777317, 261.6143531488139, 263.8651567003699, 266.0063787034284, 268.02022289351765, 269.8894889719494, 271.59765391547563, 273.1289504533711, 274.4684423824285, 275.60209640312087, 276.51685017423756, 277.2006762985736, 277.64264196868993, 277.83296401930266, 277.7630591514226, 277.4255891128885, 276.81450064033515, 275.9250599888291, 274.75388189730893, 273.29895286049197, 271.5596486009727, 269.5367456587336, 267.2324270391413, 264.6502818846028, 261.7952991593052, 258.67385536078547, 255.2936962963504, 251.6639129865042, 247.79491178145557, 243.69837880035752, 239.38723882608676, 234.87560881101993, 230.17874617130548, 225.31299206846433, 220.29570989773572, 215.14521922227277, 209.88072541106666, 204.52224525622586, 199.0905288618883, 193.60697811255773, 188.09356204294596, 182.57272944440336, 177.06731905471932, 171.60046768838313, 166.1955166732812, 160.87591696725886, 155.66513333393246, 150.58654796157558, 145.66336391184578, 140.91850878648302, 136.37453899996046, 132.05354504436116, 127.97705812949384, 124.1659585764953, 120.6403863368769, 117.41965400119062, 114.52216265226699, 111.96532090732396, 109.76546748120722, 107.93779758966409, 106.49629349690636, 105.45365949584269, 104.82126159233749, 104.6090721467215, 104.82561970663343, 105.4779442451723, 106.57155799737251, 108.11041206626138, 110.09686894729771, 112.53168109692695, 115.41397564739242, 118.74124534592107, 122.50934577205106, 126.71249886227064, 131.34330274640052, 136.3927478753821, 141.85023939539377, 147.7036256986595, 153.93923305697962, 160.54190622003273, 167.49505483696754, 174.78070553678882, 182.3795594806543, 190.27105517754535, 198.4334363338874, 206.84382448770657, 215.47829615889276, 224.3119642291317, 233.3190632481805, 242.47303834747063, 251.74663742751378, 261.1120062724404, 270.5407862331454, 280.00421411007767, 289.4732238577245, 298.9185497252958, 308.3108304420823, 317.6207140514825, 326.8189629947161, 335.8765590438461, 344.7648076839122, 353.4554415456932, 361.9207224938968, 370.1335419804331, 378.06751927874916, 385.6970972230953, 392.99763508590706, 399.94549823725094, 406.51814424246163, 412.6942050675879, 418.45356507706833, 423.77743452410573, 428.6484182514083, 433.050579338281, 436.96949744941287, 440.39232166100476, 443.30781756107024, 445.7064084427383, 447.5802104320662, 448.9230614152001, 449.7305436535586, 450.0]
        self.bot_1_y = [327.0708458829302, 319.5484133109707, 311.72808386636075, 303.6313217690382, 295.28073200006486, 286.6999842542199, 277.91373258969486, 268.9475310740802, 259.8277457418789, 250.58146319353762, 241.2363961795173, 231.82078652509887, 222.36330576239325, 212.8929538454081, 203.43895633192432, 194.0306604223245, 184.6974302504167, 175.4685418246415, 166.37307801982035, 157.43982401984627, 148.69716361038138, 140.17297671770464, 131.89453858544158, 123.88842097489548, 116.18039576723433, 108.7953413368192, 101.75715205453298, 95.08865126816718, 88.81150809374739, 82.9461583371833, 77.51172984990774, 72.5259726052465, 68.00519376420144, 63.964197980244734, 60.41623317264086, 57.37294197682837, 54.84431905861439, 52.83867445639572, 51.3626030924587, 50.42096057068747, 50.01684535382324, 50.15158738887621, 50.824743224470865, 52.034097638919775, 53.77567177275938, 56.0437377344428, 58.83083962297269, 62.127820886562404, 65.9238579120341, 70.20649971570674, 74.96171358305716, 80.17393648159236, 85.82613204919159, 91.89985293878101, 98.37530827967484, 105.2314359963132, 112.44597970654033, 119.99556990408834, 127.8558091135832, 136.00136069127123, 144.40604093084553, 153.04291412123382, 161.88439019208832, 170.90232457304518, 180.0681198845574, 189.35282907140186, 198.727259584726, 208.16207821482473, 217.62791617473798, 227.095474034184, 236.53562610435256, 245.91952387666566, 255.21869812271314, 264.4051592682178, 273.45149566105965, 282.33096936200945, 291.0176090969036, 299.48630002050373, 307.7128699550981, 315.67417178109116, 323.34816167221663, 330.7139728846063, 337.7519848266885, 344.44388715565066, 350.7727386659593, 356.72302075610423, 362.28068528119553, 367.4331966212601, 372.16956781795153, 376.4803906557919, 380.3578595879445, 383.795789430774, 386.7896267759537, 389.33645509359314, 391.4349935246236, 393.08558938543536, 394.2902044324059, 395.0523949583752, 395.37728581723866, 395.2715384965418, 394.7433133811609, 393.80222637377847, 392.45930005979653, 390.7269096255047, 388.6187237586428, 386.1496407798905, 383.3357202722076, 380.19411049225573, 376.7429718643003, 373.001396871953, 368.98932667679594, 364.72746480530583, 360.23718825650036, 355.5404563923085, 350.6597179808177, 345.61781676921333, 340.43789596837325, 335.14330203472167, 329.7574881370415, 324.30391769648054, 318.8059683870089, 313.2868369810251, 307.76944542075324, 302.2763484904869, 296.8296434576546, 291.4508820421563, 286.16098506345907, 280.9801601035836, 275.92782251143814, 271.02252005997906, 266.28186155246357, 261.72244965769016, 257.35981823664144, 253.2083744044155, 249.2813455518722, 245.59073153104623, 242.1472621872298, 238.9603603987529, 236.0381107629804, 233.38723404401313, 231.0130674740941, 228.9195509768796, 227.1092193566488, 225.58320047327237, 224.34121939844306, 223.38160852439452, 222.70132357218694, 222.2959654227136, 222.15980766999124, 222.28582977311382, 222.665755660584, 223.29009761866786, 224.14820527404007, 225.22831946038355, 226.51763073885934, 228.002342323551, 229.66773714518732, 231.4982487697241, 233.47753587279877, 235.5885599567068, 237.81366598345474, 240.134665585676, 242.53292250678066, 244.98943991272017, 247.48494921018838, 249.99999999999994]
        self.bot_1_theta = np.zeros(500)

        # self.bot_1_x = [292.7880470074263, 287.4740102210353, 282.26406480412874, 277.17783137515795, 272.23408145340613, 267.45066505106786, 262.8444424259442, 258.4312202616252, 254.225692523787, 250.24138622196756, 246.49061228605103, 242.98442174572338, 239.7325673794509, 236.7434709771879, 234.02419633810453, 231.58042810123874, 229.41645648322464, 227.53516797321163, 225.93804201086377, 224.62515364902515, 223.59518217833931, 222.84542566691644, 222.3718213441614, 222.1689717341845, 222.23017642092805, 222.5474693043358, 223.11166118466662, 223.91238749049543, 224.9381609451385, 226.17642894627144, 227.6136354144561, 229.23528684822904, 231.0260223064113, 232.96968702243203, 235.049409340788, 237.24768065235003, 239.54643799311233, 241.92714896023486, 244.37089858986985, 246.85847783334563, 249.37047326183364, 251.8873576246624, 254.38958088299773, 256.8576613386938, 259.2722764777317, 261.6143531488139, 263.8651567003699, 266.0063787034284, 268.02022289351765, 269.8894889719494, 271.59765391547563, 273.1289504533711, 274.4684423824285, 275.60209640312087, 276.51685017423756, 277.2006762985736, 277.64264196868993, 277.83296401930266, 277.7630591514226, 277.4255891128885, 276.81450064033515, 275.9250599888291, 274.75388189730893, 273.29895286049197, 271.5596486009727, 269.5367456587336, 267.2324270391413, 264.6502818846028, 261.7952991593052, 258.67385536078547, 255.2936962963504, 251.6639129865042, 247.79491178145557, 243.69837880035752, 239.38723882608676, 234.87560881101993, 230.17874617130548, 225.31299206846433, 220.29570989773572, 215.14521922227277, 209.88072541106666, 204.52224525622586, 199.0905288618883, 193.60697811255773, 188.09356204294596, 182.57272944440336, 177.06731905471932, 171.60046768838313, 166.1955166732812, 160.87591696725886, 155.66513333393246, 150.58654796157558, 145.66336391184578, 140.91850878648302, 136.37453899996046, 132.05354504436116, 127.97705812949384, 124.1659585764953, 120.6403863368769, 117.41965400119062, 114.52216265226699, 111.96532090732396, 109.76546748120722, 107.93779758966409, 106.49629349690636, 105.45365949584269, 104.82126159233749, 104.6090721467215, 104.82561970663343, 105.4779442451723, 106.57155799737251, 108.11041206626138, 110.09686894729771, 112.53168109692695, 115.41397564739242, 118.74124534592107, 122.50934577205106, 126.71249886227064, 131.34330274640052, 136.3927478753821, 141.85023939539377, 147.7036256986595, 153.93923305697962, 160.54190622003273, 167.49505483696754, 174.78070553678882, 182.3795594806543, 190.27105517754535, 198.4334363338874, 206.84382448770657, 215.47829615889276, 224.3119642291317, 233.3190632481805, 242.47303834747063, 251.74663742751378, 261.1120062724404, 270.5407862331454, 280.00421411007767, 289.4732238577245, 298.9185497252958, 308.3108304420823, 317.6207140514825, 326.8189629947161, 335.8765590438461, 344.7648076839122, 353.4554415456932, 361.9207224938968, 370.1335419804331, 378.06751927874916, 385.6970972230953, 392.99763508590706, 399.94549823725094, 406.51814424246163, 412.6942050675879, 418.45356507706833, 423.77743452410573, 428.6484182514083, 433.050579338281, 436.96949744941287, 440.39232166100476, 443.30781756107024, 445.7064084427383, 447.5802104320662, 448.9230614152001, 449.7305436535586, 450.0]
        # self.bot_1_y = [327.0708458829302, 319.5484133109707, 311.72808386636075, 303.6313217690382, 295.28073200006486, 286.6999842542199, 277.91373258969486, 268.9475310740802, 259.8277457418789, 250.58146319353762, 241.2363961795173, 231.82078652509887, 222.36330576239325, 212.8929538454081, 203.43895633192432, 194.0306604223245, 184.6974302504167, 175.4685418246415, 166.37307801982035, 157.43982401984627, 148.69716361038138, 140.17297671770464, 131.89453858544158, 123.88842097489548, 116.18039576723433, 108.7953413368192, 101.75715205453298, 95.08865126816718, 88.81150809374739, 82.9461583371833, 77.51172984990774, 72.5259726052465, 68.00519376420144, 63.964197980244734, 60.41623317264086, 57.37294197682837, 54.84431905861439, 52.83867445639572, 51.3626030924587, 50.42096057068747, 50.01684535382324, 50.15158738887621, 50.824743224470865, 52.034097638919775, 53.77567177275938, 56.0437377344428, 58.83083962297269, 62.127820886562404, 65.9238579120341, 70.20649971570674, 74.96171358305716, 80.17393648159236, 85.82613204919159, 91.89985293878101, 98.37530827967484, 105.2314359963132, 112.44597970654033, 119.99556990408834, 127.8558091135832, 136.00136069127123, 144.40604093084553, 153.04291412123382, 161.88439019208832, 170.90232457304518, 180.0681198845574, 189.35282907140186, 198.727259584726, 208.16207821482473, 217.62791617473798, 227.095474034184, 236.53562610435256, 245.91952387666566, 255.21869812271314, 264.4051592682178, 273.45149566105965, 282.33096936200945, 291.0176090969036, 299.48630002050373, 307.7128699550981, 315.67417178109116, 323.34816167221663, 330.7139728846063, 337.7519848266885, 344.44388715565066, 350.7727386659593, 356.72302075610423, 362.28068528119553, 367.4331966212601, 372.16956781795153, 376.4803906557919, 380.3578595879445, 383.795789430774, 386.7896267759537, 389.33645509359314, 391.4349935246236, 393.08558938543536, 394.2902044324059, 395.0523949583752, 395.37728581723866, 395.2715384965418, 394.7433133811609, 393.80222637377847, 392.45930005979653, 390.7269096255047, 388.6187237586428, 386.1496407798905, 383.3357202722076, 380.19411049225573, 376.7429718643003, 373.001396871953, 368.98932667679594, 364.72746480530583, 360.23718825650036, 355.5404563923085, 350.6597179808177, 345.61781676921333, 340.43789596837325, 335.14330203472167, 329.7574881370415, 324.30391769648054, 318.8059683870089, 313.2868369810251, 307.76944542075324, 302.2763484904869, 296.8296434576546, 291.4508820421563, 286.16098506345907, 280.9801601035836, 275.92782251143814, 271.02252005997906, 266.28186155246357, 261.72244965769016, 257.35981823664144, 253.2083744044155, 249.2813455518722, 245.59073153104623, 242.1472621872298, 238.9603603987529, 236.0381107629804, 233.38723404401313, 231.0130674740941, 228.9195509768796, 227.1092193566488, 225.58320047327237, 224.34121939844306, 223.38160852439452, 222.70132357218694, 222.2959654227136, 222.15980766999124, 222.28582977311382, 222.665755660584, 223.29009761866786, 224.14820527404007, 225.22831946038355, 226.51763073885934, 228.002342323551, 229.66773714518732, 231.4982487697241, 233.47753587279877, 235.5885599567068, 237.81366598345474, 240.134665585676, 242.53292250678066, 244.98943991272017, 247.48494921018838, 249.99999999999994]
        # self.bot_1_theta = np.zeros(500)


        self.xPose = 0.0
        self.yPose = 0.0
        self.thetaPose = 0.0

        self.Kp = 1.2
        self.Kw = 0.8

        # Initialze Publisher and Subscriber
        # NOTE: You are strictly NOT-ALLOWED to use "cmd_vel" or "odom" topics in this task
        # Use the below given topics to generate motion for the robot.
        #   /hb_bot_1/left_wheel_force,
        #   /hb_bot_1/right_wheel_force,
        #   /hb_bot_1/left_wheel_force

        self.left_wheel_force = self.create_publisher(
            Wrench, '/hb_bot_3/left_wheel_force', 10)
        self.right_wheel_force = self.create_publisher(
            Wrench, '/hb_bot_3/right_wheel_force', 10)
        self.rear_wheel_force = self.create_publisher(
            Wrench, '/hb_bot_3/rear_wheel_force', 10)
        
        # self.is_pen_down = self.create_publisher(
        #     Bool, '/is_pen_down', 10)

        # Similar to this you can create subscribers for hb_bot_2 and hb_bot_3
        # self.subscription = self.create_subscription(
        #     Goal,
        #     'hb_bot_1/goal',
        #     self.goalCallBack,  # Callback function to handle received messages
        #     10  # QoS profile, here it's 10 which means a buffer size of 10 messages
        # )

        self.subscription_pose = self.create_subscription(
            Pose2D, '/pen3_pose', self.aruco_callback, 10)

        # self.subscription  # Prevent unused variable warning
        # For maintaining control loop rate.
        self.rate = self.create_rate(100)
        self.index = 0

    def inverse_kinematics(self, x_vel, y_vel, theta_vel, value):
        ############ ADD YOUR CODE HERE ############

        # INSTRUCTIONS & HELP :
        # -> Use the target velocity you calculated for the robot in previous task, and
        # Process it further to find what proportions of that effort should be given to 3 individuals wheels !!
        # Publish the calculated efforts to actuate robot by applying force vectors on provided topics
        ##################################################################

        d = 500/22

        rotation_matrix = np.array([[  -0.5  ,  -np.sqrt(3)/2  ,  -d   ],
                                    [  -0.5  ,   np.sqrt(3)/2  ,  -d   ],
                                    [     1  ,   0             ,  -d   ] ] ) 

        [u1, u2, u3] = np.dot(rotation_matrix, [x_vel, y_vel, theta_vel]) 

        forces_left = Wrench()
        forces_right = Wrench()
        forces_rear = Wrench()

        print(u1, u2, u3)

        forces_left.force.y = u1
        forces_right.force.y = u2
        forces_rear.force.y = u3
        forces_rear.force.x = value

        self.right_wheel_force.publish(forces_right)
        self.left_wheel_force.publish(forces_left)
        self.rear_wheel_force.publish(forces_rear)

        pass

    def goalCallBack(self, msg):
        self.bot_1_x = msg.x
        self.bot_1_y = msg.y
        self.bot_1_theta = np.radians(msg.theta)

    def aruco_callback(self, data):
        self.xPose = data.x
        self.yPose = data.y
        self.thetaPose = data.theta

        # print(data.x, data.y, data.theta)


def main(args=None):
    rclpy.init(args=args)

    hb_controller = HBController()
    x_goal1 = hb_controller.bot_1_x
    y_Goal1 = hb_controller.bot_1_y
    theta1 = hb_controller.bot_1_theta

    print(x_goal1, y_Goal1, theta1)
    value = 0.0

    # while x_goal1 == 0.0:
    #     rclpy.spin_once(hb_controller)
    #     x_goal1 = hb_controller.bot_1_x
    #     y_Goal1 = hb_controller.bot_1_y
    #     theta1 = hb_controller.bot_1_theta


    if x_goal1 != 0.0:
        # Main loop
        while rclpy.ok():

            # if hb_controller.index == 5 :
                # msgs = Bool()
                # msgs.data = False
                # hb_controller.is_pen_down.publish(msgs)
                # hb_controller.inverse_kinematics(0, 0, 0)
                # break
            

            x_goal = x_goal1[hb_controller.index]
            y_goal = y_Goal1[hb_controller.index]
            theta_goal = theta1[hb_controller.index]

            ####################################################
            # print("x Goal " + str(x_goal), "y Goal " + str(y_goal), "theta Goal " + str(theta_goal))
            x_err = x_goal - hb_controller.xPose
            y_err = y_goal - hb_controller.yPose
            theta_err = theta_goal - hb_controller.thetaPose
            print("x_err = " + str(x_err), y_err, theta_err)

            x_err_body = math.cos(hb_controller.thetaPose) * x_err - math.sin(hb_controller.thetaPose) * y_err
            y_err_body = math.sin(hb_controller.thetaPose) * x_err + math.cos(hb_controller.thetaPose) * y_err

            vel_x = hb_controller.Kp * x_err_body
            vel_y = -hb_controller.Kp * y_err_body
            W_z = -hb_controller.Kw * theta_err
            # Safety Check
            # make sure the velocities are within a range.
            if vel_x > 13:
                vel_x = 13
            if vel_x < -13:
                vel_x = -13
            if vel_y > 13:
                vel_y = 13
            if vel_y < -13:
                vel_y = -13
            if W_z > 13:
                W_z = 13
            if W_z < -13:
                W_z = -13

            hb_controller.inverse_kinematics(vel_x, vel_y, W_z, value)
            # msgs = Bool()
            # msgs.data = False
            # hb_controller.is_pen_down.publish(msgs)

            if abs(x_err) <= 5 and abs(y_err) <= 5 and abs(theta_err) <= 0.1 and hb_controller.index < 165:
                print("reached")
                hb_controller.index = hb_controller.index + 1
                value = 1.0
            
            elif hb_controller.index == 165:
                hb_controller.inverse_kinematics(0, 0, 0, 0.0)
                # msgs = Bool()
                # msgs.data = True
                # hb_controller.is_pen_down.publish(msgs)
                # hb_controller.inverse_kinematics(vel_x, vel_y, W_z)
            


        # Spin once to process callbacks
            rclpy.spin_once(hb_controller)

    else:
        rclpy.spin_once(hb_controller)

    # Destroy the node and shut down ROS
    hb_controller.destroy_node()
    rclpy.shutdown()


# Entry point of the script
if __name__ == '__main__':
    main()
